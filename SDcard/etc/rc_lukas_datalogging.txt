#!nsh
#
# PX4FMU startup script.
 
# Disable autostarting other apps
set MODE custom

#
# Start terminal
#
if sercon
then
	echo "USB connected"
fi
 
#
# Start the ORB (first app to start)
#
uorb start
 
#
# Load microSD params
#
#if ramtron start
#then
#	param select /ramtron/params
#	if [ -f /ramtron/params ]
#	then
#		param load /ramtron/params
#	fi
#else
	param select /fs/microsd/params
	if [ -f /fs/microsd/params ]
	then
		if param load /fs/microsd/params
		then
			echo "Parameters loaded"
		else
			echo "Parameter file corrupt - ignoring"
		fi
	fi
#fi
 
#
# Start system state indicator
#
if rgbled start
then
	echo "Using external RGB Led"
else
	if blinkm start
	then
		blinkm systemstate
	fi
fi
 
# Try to get an USB console
nshterm /dev/ttyACM0 &
 
#
# Do not exit the shell per default
#
set EXIT_ON_END no
 
#
# Start and configure PX4IO or FMU interface
#
if px4io detect
then
	# Start MAVLink (depends on orb)
	mavlink start
	usleep 5000
 
	sh /etc/init.d/rc.io
else
	# Start MAVLink (on UART1 / ttyS0)
	mavlink start -d /dev/ttyS0
	usleep 5000
	fmu mode_pwm
	param set BAT_V_SCALING 0.004593
	set EXIT_ON_END yes
fi
 
#
# Start the sensors and test them.
#
sh /etc/init.d/rc.sensors
 
#
# Start the commander.
#
commander start
 
#
# Start XSENS interface
#
xsens start
 
#
# Start the attitude position estimator
# This is the internal Kalman Filter of the PX4
#
att_pos_estimator_ekf start
 
#
# Start Data logging with 50Hz
#
sdlog2 start -r 50 -e

if [ $EXIT_ON_END == yes ]
then
	exit
fi